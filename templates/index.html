{% extends 'base.html' %}
<!DOCTYPE html>
<html lang="en">
  <head>
    {% block head %}
    {{super()}}
    {% endblock %}
  </head>
  <body>
    {% block body %}
    {{super()}}
    <div class="cover" id="loader">
      <div class="loader">
        <div class="spin"></div>
        <p style="font-weight: bolder; font-size: 2rem; color: #403D39;">Подождите</p>
        <p style="font-weight: bolder; font-size: 1rem; color: #403D39;">Идёт загрузка</p>
      </div>
    </div>
    <header></header>
    <main>
      <div class="wrapper">
        <div class="container">
          <p class="header">Город в деталях: цифровая экспертиза</p>
          <p class="subheader">Детальное сравнение изображений и выявление отличий цвета, текста, формы и размера</p>

          <form action="/" method="post" enctype="multipart/form-data" id="form">
            <div class="fileSelection">
              <div class="uploadWrapper" id="uploadFirst">
                <div class="upload">
                  <div id="labelsFirst">
                    <label for="first"><img src="{{url_for('static', filename='images/upload.png')}}" width="100px" height="100px"></label>
                    <label for="first" style="font-size: 1.25rem; font-weight: bolder;">Оригинальное изображение</label>
                    <label for="first" style="font-size: 1.25rem; font-weight: bolder;">Выберите или перетащите сюда изображение</label>
                    <label for="first" style="font-size: 1.25rem; font-weight: bolder;">(.png, .jpg)</label>
                    <label for="first" id="invalidFirst" style="font-size: 1.3rem; font-weight: bolder;"><br><br>Выбран не тот формат файла</label>
                  </div>
                  <input type="file" name="first" required accept="image/png,image/jpeg" id="first">
                  <img src="" id="previewFirst" class="disabled">
                  <div class="delete" id="firstDelete">
                    <img src="{{url_for('static', filename='images/trash.png')}}" alt="Удалить первое изображение">
                  </div>
                </div>
              </div>
              <div class="uploadWrapper" id="uploadSecond">
                <div class="upload">
                  <div id="labelsSecond" disabled>
                    <label for="second"><img src="{{url_for('static', filename='images/upload.png')}}" width="100px" height="100px"></label>
                    <label for="second" style="font-size: 1.25rem; font-weight: bolder;">Изображение для сравнения</label>
                    <label for="second" style="font-size: 1.25rem; font-weight: bolder;">Выберите или перетащите сюда изображение</label>
                    <label for="second" style="font-size: 1.25rem; font-weight: bolder;">(.png, .jpg)</label>
                    <label for="second" id="invalidSecond" style="font-size: 1.3rem; font-weight: bolder;"><br><br>Выбран не тот формат файла</label>
                  </div>
                  <input type="file" name="second" required accept="image/png,image/jpeg" id="second">
                  <img src="" id="previewSecond" class="disabled">
                  <div class="delete" id="secondDelete">
                    <img src="{{url_for('static', filename='images/trash.png')}}" alt="Удалить второе изображение">
                  </div>
                </div>
              </div>
            </div>
            <input type="submit" value="Сравнить" id="uploadBtn">
          </form>
        </div>
      </div>
    </main>
    <script>

      let firstFile = null;
      let secondFile = null;

      const first = document.getElementById("uploadFirst");
      const second = document.getElementById("uploadSecond");
      const inputFirst = document.getElementById("first");
      const inputSecond = document.getElementById("second");
      var firstFiles = inputFirst.files;
      var secondFiles = inputSecond.files;
      const previewFirst = document.getElementById("previewFirst");
      const previewSecond = document.getElementById("previewSecond");
      const labelsFirst = document.getElementById("labelsFirst");
      const labelsSecond = document.getElementById("labelsSecond");
      const btn = document.getElementById("uploadBtn");
      const form = document.getElementById("form");
      const loader = document.getElementById("loader");
      const invalidFirst = document.getElementById("invalidFirst");
      const invalidSecond = document.getElementById("invalidSecond");
      const deleteFirst = document.getElementById("firstDelete");
      const deleteSecond = document.getElementById("secondDelete");

      function deleteFirstFile()
      {
        addFirstFile(null);
        updatePreviewFirst(null);
      }

      function deleteSecondFile()
      {
        addSecondFile(null);
        updatePreviewSecond(null);
      }

      function clear() {
        form.reset();
      }

      function addFirstFile(file)
      {

        if (file == null)
        {
          firstFile = null;
          uploadBtn.setAttribute("disabled", "");
          return;
        }

        firstFile = file;
        if (file.type != "image/png" && file.type != "image/jpeg")
        {
          invalidFirst.style.display = "block";
          uploadBtn.setAttribute("disabled", "");
          return;
        }

        if (firstFile != null && secondFile != null)
        {
          uploadBtn.removeAttribute("disabled");
        } else {
          uploadBtn.setAttribute("disabled", "");
        }
      }

      function addSecondFile(file)
      {

        if (file == null)
        {
          secondFile = null;
          uploadBtn.setAttribute("disabled", "");
          return;
        }

        secondFile = file;
        if (file.type != "image/png" && file.type != "image/jpeg")
        {
          invalidSecond.style.display = "block";
          uploadBtn.setAttribute("disabled", "");
          return;
        }

        if (firstFile != null && secondFile != null)
        {
          uploadBtn.removeAttribute("disabled");
        } else {
          uploadBtn.setAttribute("disabled", "");
        }
      }

      function dropHandler(ev) {
        ev.preventDefault();
        for (const it of ev.dataTransfer.items)
        {
          if (ev.currentTarget.getAttribute("id") == "uploadFirst")
          {
            var f = it.getAsFile()
            addFirstFile(f);
            updatePreviewFirst(f);
          } else {
            var f = it.getAsFile()
            addSecondFile(f);
            updatePreviewSecond(f);
          }
        }
      }

      function uploadHandler(ev) {
        ev.preventDefault();
        for (const it of ev.target.files)
        {
          if (ev.currentTarget.getAttribute("id") == "uploadFirst")
          {
            addFirstFile(it);
            updatePreviewFirst(it);
          } else {
            addSecondFile(it);
            updatePreviewSecond(it);
          }
        }
      }

      function updatePreviewFirst(file)
      {
        if (file == null || (file.type != "image/png" && file.type != "image/jpeg"))
        {
          previewFirst.classList.add("disabled");
          labelsFirst.classList.remove("disabled");
          deleteFirst.style.display = "none";
        } else { 
          let reader = new FileReader();
          reader.readAsDataURL(file);

          reader.onload = (ev) => {
            let imgURL = ev.target.result;
            previewFirst.src = imgURL;
            previewFirst.classList.remove("disabled");
            labelsFirst.classList.add("disabled");
            deleteFirst.style.display = "block";
          }
        }
      }

      function updatePreviewSecond(file)
      {
        if (file == null || (file.type != "image/png" && file.type != "image/jpeg"))
        {
          previewSecond.classList.add("disabled");
          labelsSecond.classList.remove("disabled");
          deleteSecond.style.display = "none";
        } else { 
          let reader = new FileReader();
          reader.readAsDataURL(file);

          reader.onload = (ev) => {
            let imgURL = ev.target.result;
            previewSecond.src = imgURL;
            previewSecond.classList.remove("disabled");
            labelsSecond.classList.add("disabled");
            deleteSecond.style.display = "block";
          }
        }
      }

      function loadHandler(ev)
      {
        ev.preventDefault();

        let formData = new FormData();
        formData.append("first", firstFile, firstFile.name);
        formData.append("second", secondFile, secondFile.name);

        loader.style.display = "flex";
        let xhr = new XMLHttpRequest(); 
        xhr.open("POST", "/index");
        xhr.send(formData);
        xhr.onload = function() {
          if (xhr.status != 200)
          {
            alert("Ошибка! Статус " + xhr.status);
            loader.style.display = "none";
          } else {
            loader.style.display = "none";
            window.location.href = "/result";
          }
        }
      }

      // clear form data
      clear();

      first.addEventListener("drop", dropHandler);
      first.addEventListener("change", uploadHandler);
      second.addEventListener("drop", dropHandler);
      second.addEventListener("change", uploadHandler);
      uploadBtn.addEventListener("click", loadHandler);
      uploadBtn.setAttribute("disabled", "");
      invalidFirst.style.display = "none";
      invalidSecond.style.display = "none";
      deleteFirst.style.display = "none";
      deleteFirst.addEventListener("click", deleteFirstFile);
      deleteSecond.style.display = "none";
      deleteSecond.addEventListener("click", deleteSecondFile);

      // reload page on browser back
      window.addEventListener( "pageshow", function ( event ) {
        var historyTraversal = event.persisted || 
          ( typeof window.performance != "undefined" && 
            window.performance.navigation.type === 2 );
        if ( historyTraversal ) {
          // Handle page restore.
          window.location.reload();
        }
      });
    </script>
    {% endblock %}
  </body>
</html>
